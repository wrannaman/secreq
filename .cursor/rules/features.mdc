---
description: description of the project's necessary features
globs:
alwaysApply: false
---
- 1) Single “Workbench” page
  - Route: `questionnaires/[id]/workbench`
  - Replaces mapping/export pages and buttons everywhere (remove old flows)

- 2) Upload and load originals
  - Drag/drop or “Choose file” (XLSX/CSV)
  - Store to Supabase, persist path, return signed URL
  - Fallback: load existing file by questionnaire if already uploaded

- 3) Exact Excel/CSV viewer
  - Client-side parse (ExcelJS for XLSX, Papa for CSV) via signed URL ArrayBuffer
  - Render merges with true colSpan/rowSpan, column resize, keyboard nav, copy/paste
  - Virtualized grid for large files; dark mode-ready

- 4) Selection-driven mapping
  - User selects question cells/rows and a target answer column
  - Quick actions: “Use suggested question/answer columns”, “Set as answer column”
  - Persist mapping per worksheet in Supabase (`excel_column_mapping`)

- 5) Knowledge base toggle
  - Dataset selector (multi-select) docked at top
  - Selected dataset IDs flow into generation requests

- 6) AI generation on demand (and smart prefill)
  - Button: “Fill answers in selected column”
  - Batch by selection or detected question rows; stream status; progress per batch
  - Confidence badges; citations viewer

- 7) Inline edit/accept/retry
  - Click blue cell to edit inline; Cmd/Ctrl+Enter to save; Esc to cancel
  - Actions per cell: Accept, Retry with guidance, Revert to original
  - Copy/paste (Cmd/Ctrl+C/V) across cells; supports multi-cell paste in answer column

- 8) Autosave and change tracking
  - Store cell-level edits and per-row status (ai_generated/reviewed)
  - Dirty indicators; undo/redo per session
  - “Ready to export” checklist (N remaining unfilled/unreviewed)

- 9) Export exact file
  - POST `/api/export-excel/[id]` to inject answers into the original workbook (preserve formatting/merges/styles)
  - CSV export path for CSV originals
  - File name: `<original>_completed.xlsx` (or `.csv`)

- 10) Performance, telemetry, safeguards
  - Web worker parsing for big files; chunked AI batches; retry/backoff
  - Robust error toasts; signed URL expiry handling
  - Analytics on time-to-first-answer and time-to-export; enforce access via Supabase auth

Deliverables: new workbench page and components, updated APIs (`upload`, `signed-url`, `export-excel`), deprecate old mapping/export pages and buttons.